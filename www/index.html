<!DOCTYPE html>
<html>
	<head>
		<title></title>
		<meta content="">
		<meta charset="utf-8">
		<style>
			*{
				box-sizing: border-box; 
				margin:0;
				border:0;
				padding:0;
			}
			:root{
				--kopfproz: 0.08;
				--fussproz: 0.60;
			}
			body, html {
				height: 100%;
				margin: 0;
				background-color: hsl(200, 50%, 95%);
			}
			.kopfleiste{
				height: calc(100vh * var(--kopfproz));
				width: 100vw;
				background-color: hsl(180, 80%, 50%);
				background-image: url("/welle.svg");
				background-position: center;
				background-repeat: no-repeat;
				background-size: cover;
				box-shadow: inset 0 0 0.9vh 0.6vh #5599FF99;
				overflow : hidden;
			}
			.titel{
				--tproz: 0.8;
				font-size: calc(100vh * var(--tproz) * var(--kopfproz));
				color: hsl(60, 100%, 60%);
				text-align: center ;
				text-shadow: 0 0 1vh #FF0000;
				text-shadow: 0 0 1.3vh #DD00DD;
				text-shadow: 0 0 1.5vh #0000FF;
			}
			.fenster{
				height: calc(100vh * calc(var(--fussproz) - var(--kopfproz)));
				width: 100vw;
				background-color: hsl(200, 50%, 95%);
				overflow: hidden;
			}
			.steuerung{
				height: calc(100vh * calc(1 - var(--fussproz)));
				width: 100vw;
				background-color: hsl(200, 60%, 90%);
				overflow : hidden;
				top: 54vh;
			}
			.steuerung *{
				--tabproz: 0.2;
				--tabpos: calc(100vh * calc(var(--fussproz) + calc(var(--tabproz) * calc(1 - var(--fussproz)))));
			}
			.kategorien{
				height: 100%;
				width: 100%;
			}
			.kategorie{
				float: left;
				height: 90%;
				width: calc(100vw / 6);
				padding: 1vh;
				background-color: hsl(200, 60%, 90%);
			}
			.schale{
				width: 100%;
				height: 100%;
				border: 1vh;
				border-style: solid;
				border-radius: 1vh;
				border-color: hsl(200, 60%, 70%);
				overflow: hidden;
				padding: 5%;
			}
			.tabwahl{
				display:none;
			}
			.tabrad{
				display:none;
			}
			.mauswahl{
				width:50%;
				height:40%;
				display:block;
				float:left;
			}
			.formelfeld{
				width:100%;
				height:85%;
				float:left;
			}
			.formelwahl{
				width:50%;
				height:15%;
				float:left;
			}
			.formelstart{
				width:50%;
				height:15%;
				float:left;
			}
			.tabtitel{
				width:100%;
				height:10%;
			}
			.zeichenfeld{
				overflow: hidden;
				width:100%;
				height:100%;
			}
			@media (max-width: 700px) {
				.tabwahl{
					display:block;
					height: 20%;
					width:100%;
				}
				.kategorie{
					width : 100vw;
					height : calc(100vh - var(--tabpos) );
					top: var(--tabpos);
					position: fixed;
					display: none;
				}
				.tabrad:checked + .kategorie{
					display: block;
				}
				.tabtitel{
					display: none;
				}
			}
		</style>
		</head>
	<body style="margin:0;">
		<div class="kopfleiste">
			<h1 class="titel">Quantsimulant</h1>
		</div>
		<div class="fenster" id="fenster">
			<canvas id = "canv" class = "zeichenfeld"></canvas>
		</div>
		<div class="steuerung">
			<select class="tabwahl" id="tabsel" onchange = "document.getElementById('radio' + document.getElementById('tabsel').value).checked = true">
				<option value="1">Info</option>
				<option value="2" selected>Navigation</option>
				<option value="3">Parameter</option>
				<option value="4">Werkzeuge</option>
				<option value="5" selected>Darstellung</option>
				<option value="6">Formel</option>
			</select>
			<div class = "kategorien">
				<input class = "tabrad" type = "radio" name = "tabrad" id = "radio1" checked></input>
				<div class="kategorie" id="info">
					<h2 class = "tabtitel">Info</h2>
					<div class= "schale">
						<div class = "infoeck" id = "infoeck">
							<a href = "./info.html" target="_blank">Anleitung und Infos zur Website anzeigen</a>
							<div id = "zeitinfo">Zeit: <font id = "zeitlabel"></font></div>
							<div id = "norminfo">Norm: <font id = "normlabel"></div>
							<div id = "xinfo">X: <font id = "xlabel"></div>
							<div id = "vekyinfo">Y (Vektor Realteil): <font id = "vekylabel"></div>
							<div id = "quadyinfo">Y (Vektor Betragsquadrat): <font id = "quadylabel"></div>
							<div id = "potyinfo">Y (Potential): <font id = "potylabel"></div>
						</div>
					</div>
				</div>
				<input class = "tabrad" type = "radio" name = "tabrad" id = "radio2"></input>
				<div class="kategorie" id="navigation">
					<h2 class = "tabtitel">Navigation</h2>
					<div class= "schale">
						<div>
							<button onclick = "neustart()" left = "50px" top = "30px" id = "neustart">Zur&uumlcksetzen</button>
							<button onclick = "start_stop()" left = "50px" top = "30px" id = "startstop">Start</button>
							<a href="" id="speicherlink" style = "display:none"> </a>
							<div>
								<button onclick = "speichern()" left = "50px" top = "30px" id = "spe">Speichern</button>
								<select id="speicherverhalten">
									<option value=1>Alles Speichern</option>
									<option value=2>Potential Speichern</option>
									<option value=0>Wellenfunktion Speichern</option>
								</select>
								<button onclick = "dateiwahl.click()" left = "50px" top = "30px" id = "lad">Laden</button>
							</div>
							<input type='file' onchange='laden(event)' id = "datw" style = "display:none">
							Wellenfunktion Vergr&oumlßerung: <input type="number" onchange = "ansichtsAenderung()" step = "any" id = "vekgroesse" value=10></input>
							Betragsquadrat Wellenfunktion Vergr&oumlßerung: <input type="number" onchange = "ansichtsAenderung()" step = "any" id = "quadvekgroesse" value=200></input>
							Potential Vergr&oumlßerung: <input type="number" onchange = "ansichtsAenderung()" step = "any" id = "potgroesse" value=10></input>
						</div>
					</div>
				</div>
				<input class = "tabrad" type = "radio" name = "tabrad" id = "radio3"></input>
				<div class="kategorie" id="parameter">
					<h2 class = "tabtitel">Parameter</h2>
					<div class= "schale">
						<div>
							Aktuelle Zeit: <input type="number" value = 0 step = "any" id = "zeit" placeholder="0"></input>
							Delta_t: <input type="number" value = 0.1 onchange = "parameter_auslesen()" step = "any" id = "delta_t" placeholder="0"></input>
							Zeitschritte pro Frame: <input type="number" onchange = "parameter_auslesen()" step = "any" id = "schritteproframe" placeholder="0"></input>
							
							Masse: <input type="number" onchange = "vektoraktualisieren()" step = "any" id = "mas" placeholder="1"></input>
							Kastenbreite: <input type="number" onchange = "vektoraktualisieren()" step = "any" id = "breite" placeholder="0"></input>
							Ortsgitterpunkte: <input type="number" onchange = "vektoraktualisieren()" step = "any" id = "gitterpunkte" placeholder="1"></input>
							Periodisch: <input type="checkbox" onchange = "vektoraktualisieren()" id = "keinrand"></input>
						</div>
					</div>
				</div>
				<input class = "tabrad" type = "radio" name = "tabrad" id = "radio4"></input>
				<div class="kategorie" id="werkzeuge">
					<h2 class = "tabtitel">Werkzeuge</h2>
					<div class= "schale">
						<select class="mauswahl" id="linkmaus" onchange="stiftAendern()">
							<option value="potstift">Potential zeichnen</option>
							<option value="vekstift">Wellenfunktion zeichnen</option>
							<option value="potstift_g">Potential Linie zeichnen</option>
						</select>
						<select class="mauswahl" id="rechtmaus" onchange="stiftAendern()">
							<option value="potstift">Potential zeichnen</option>
							<option value="vekstift">Wellenfunktion zeichnen</option>
							<option value="potstift_g">Potential Linie zeichnen</option>
						</select>
						<div>
							Lineare Potential&aumlnderung<input type="checkbox" id = "potmodus" onchange = "potmodusumschalten()"></input>
							<button onclick = "normierevek()" left = "50px" top = "30px" id = "startstop">Normieren</button>
							<button onclick = "glaetten_funktion()" left = "50px" top = "30px" id = "startstop">Gl&aumltten</button>
							Gl&aumltten Ordnung: <input type="number" step = 1 id = "glaettordnung" value = 100></input>
						</div>
					</div>
				</div>
				<input class = "tabrad" type = "radio" name = "tabrad" id = "radio5"></input>
				<div class="kategorie" id="darstellung">
					<h2 class = "tabtitel">Darstellung</h2>
					<div class= "schale">
						<div>
							Realanteil: <input type="checkbox" id = "Rcheck" onchange = "anzeigeAendern()"></input><input type="color" value="#ff0000" id = "Rfarbe" onchange = "zeichnen()">
						</div>
						<div>
							Imagin&aumlrteil: <input type="checkbox" id = "Icheck" onchange = "anzeigeAendern()"></input><input type="color" value="#00ff00" id = "Ifarbe" onchange = "zeichnen()">
						</div>
						<div>
							3D-Projektion: <input type="checkbox" id = "D3check" onchange = "anzeigeAendern()"></input><input type="color" value="#1234fa" id = "D3farbe" onchange = "zeichnen()">
						</div>
						<div>
							Potential: <input type="checkbox" id = "Pcheck" onchange = "anzeigeAendern()"></input><input type="color" value="#000000" id = "Pfarbe" onchange = "zeichnen()">
						</div>
						<div>
							Betragsquadrat: <input type="checkbox" id = "Qcheck" onchange = "anzeigeAendern()"></input><input type="color" value="#de5f11" id = "Qfarbe" onchange = "zeichnen()">
						</div>
						<div>
							Strichst&aumlrke: <input type="number" onchange = "zeichnen()" step = "any" id = "strichstaerke" value = 5></input>
						</div>
					</div>
				</div>
				<input class = "tabrad" type = "radio" name = "tabrad" id = "radio6"></input>
				<div class="kategorie" id="formelkategorie">
					<h2 class = "tabtitel">Formel</h2>
					<div class= "schale">
						<textarea class = "formelfeld" id="formel"></textarea>
						<select class = "formelwahl" id="formelwahl" onchange="formelAendern()">
							<option value="formelwählen">Beispiele</option>
							<option value="test">test</option>
							<option value="gauss">Gaußsche Glockenkurve</option>
							<option value="kastenmoden">Moden des unendlich hohen Kastenpotentials</option>
							<option value="kasten">Endlicher Kasten</option>
							<option value="harmonisch">Harmonischer Oszillator Potential</option>
							<option value="oszillatormoden">Harmonischer Oszillator Potential, Eigenwerte</option>
							<option value="defokus">Potentielle Energie</option>
							<option value="impulsversch">Verschiebung im Impulsraum</option>
							<option value="einsdurchx">a / |x|</option>
							<option value="interferenzexp">Interferenzexperiment</option>
							<option value="gitter">Gitter</option>
						</select>
						<button class = "formelstart" id = "formelanwenden"  onclick = "formelanwenden()">Anwenden</button>
					</div>
				</div>
			</div>
		</div>
		<script type = "Module">
		
import {Numerik, Fenster} from "./importest.js"
var cl = console.log
var s1d = new Numerik(bereit)
var Modul = s1d.Modul

var fe = new Fenster(document.getElementById("fe"))
		
var Konzepte = [];

var werkzeuge = [];
var komponenten = [];

var vekgroesse = document.getElementById("vekgroesse");
var quadvekgroesse = document.getElementById("quadvekgroesse");
var potgroesse = document.getElementById("potgroesse");

var Rcheck = document.getElementById("Rcheck");
var Icheck = document.getElementById("Icheck");
var Qcheck = document.getElementById("Qcheck");
var D3check = document.getElementById("D3check");
var Pcheck = document.getElementById("Pcheck");
Rcheck.checked = false;
Icheck.checked = false;
Qcheck.checked = false;
D3check.checked = true;
Pcheck.checked = true;

var Rfarbe = document.getElementById("Rfarbe");
var Ifarbe = document.getElementById("Ifarbe");
var Qfarbe = document.getElementById("Qfarbe");
var D3farbe = document.getElementById("D3farbe");
var Pfarbe = document.getElementById("Pfarbe");

var zeitlabel = document.getElementById("zeitlabel");
var normlabel = document.getElementById("normlabel");
var xlabel = document.getElementById("xlabel");
var vekylabel = document.getElementById("vekylabel");
var quadylabel = document.getElementById("quadylabel");
var potylabel = document.getElementById("potylabel");

var infoeck = document.getElementById("infoeck");

var zeitinfo = document.getElementById("zeitinfo");
var norminfo = document.getElementById("norminfo");
var xinfo = document.getElementById("xinfo");
var vekyinfo = document.getElementById("vekyinfo");
var quadyinfo = document.getElementById("quadyinfo");
var potyinfo = document.getElementById("potyinfo");

var strichstaerke = document.getElementById("strichstaerke");
glaettordnung = document.getElementById("glaettordnung");
var potmodus = document.getElementById("potmodus");
potmodus.checked = false;

var parameterblock = document.getElementById("parameterblock");
var parameterblockda = true;
	
var canvas = document.getElementById("canv");
var ctx = canvas.getContext("2d");
var fenster = document.getElementById("fenster");

var startstop_button = document.getElementById("startstop");
var dateiwahl = document.getElementById("datw");
window.dateiwahl = dateiwahl
var formelfeld = document.getElementById("formel");

var speicherlink = document.getElementById("speicherlink");

//var zeit_anzeige = document.getElementById("zeit");
var uhr = document.getElementById("zeit");
//var zeit = 0;

var zeitraum_anzeige = document.getElementById("zeitraum");
var zeitraum = 1000;//200;//

var deltat = document.getElementById("delta_t");

var ordnung_anzeige = document.getElementById("ordnung");
var ordnung = 1;

var zeitschritte_anzeige = document.getElementById("zeitschr");
var zeitschritte = 10000;//141;

var gitterpunkte_anzeige = document.getElementById("gitterpunkte");
var gitterpunkte = 1000;

var masse_anzeige = document.getElementById("mas");
var masse = 1;

var keinrand_anzeige = document.getElementById("keinrand");
var keinrand = 0;

var breite_anzeige = document.getElementById("breite");
var breite = 1000;

var outpanzeige = document.getElementById("outp");
var outp = "";

var quaddiff_anzeige = document.getElementById("quaddiff");
var mdiff;

var betrquad_anzeige = document.getElementById("betrquad");
var betrquad;

var betrdurch_anzeige = document.getElementById("betrdurch");
var betrdurch;

var start_zp;

var lstiftselect = document.getElementById("linkmaus");
var rstiftselect = document.getElementById("rechtmaus");
var vekstiftordnung = 100;

var formelwahl = document.getElementById("formelwahl");

var schritteproframe = document.getElementById("schritteproframe");
schritteproframe.value = 20;

var gp_zp_ae_anzeige = document.getElementById("gp_zp_ae");
var gp_zp_ae = 50;

var gp_zp_ges_anzeige = document.getElementById("gp_zp_ges");
var gp_zp_ges = 1;

var gp_zp_zaehler;

var start_gp;

var gp_rp_ae_anzeige = document.getElementById("gp_rp_ae");
var gp_rp_ae = 50;

var gp_rp_ges_anzeige = document.getElementById("gp_rp_ges");
var gp_rp_ges = 1;

var gp_rp_zaehler;

var start_m;

var gp_m_ae_anzeige = document.getElementById("gp_m_ae");
var gp_m_ae = 1;

var gp_m_ges_anzeige = document.getElementById("gp_m_ges");
var gp_m_ges = 1;

var gp_m_zaehler;

var start_o;

var gp_o_ae_anzeige = document.getElementById("gp_o_ae");
var gp_o_ae = 1;

var gp_o_ges_anzeige = document.getElementById("gp_o_ges");
var gp_o_ges = 1;

var gp_o_zaehler;

var gp_wh_anzeige = document.getElementById("wiederhol");
var gp_wh = 1;

var gp_wh_zaehler;

var start_z;

var malen = false;

var xalt = null;
var yaly = null;

var xinnenanf = 0;
var xinnenend = breite;
var yinnenanf = 0.07;
var yinnenend = -0.07;
var yinnenanfQ = 0.003;
var yinnenendQ = -0.003;

var wellnorm = 0.01;
var wellenberge = 1;

var pinsel;
var messort;

var gitterPunktAbstand = 1;
//var zeitschritt = zeitraum / zeitschritte;

var wandelpot_aufl = 0.000001;

var bildschirmbreite = 1900;
var bildschirmhoehe = 1000;

var yskal = 0.07;

var aktiv = false;
var berechnen;
var zerleg;
var cbuff;
var wandelpot;

var nl = "\r\n";

var framezahl = 0;

var datn;

var bytenr = Number("f64".substring(1));
var l_f64 = bytenr / 8;
var l_f64_potenz = Math.round(Math.log(l_f64) / Math.log(2));

var anfwert = 0;

var rotationswinkel = 0;
var rotationsgeschwindigkeit = 0.05;

var xalt;
var yalt;
var koord;
var koordPot;
var koordQ;

var stift;
var lstift;
var rstift;


var getf64;
var setf64;
var re_f64_wertbei;
var im_f64_wertbei;
var f64_wertbei;
var Dsetzekonst;
var cf64_SchwingungsZerlegung;
var cf64_SchwingungsZusammensetzung;
var schwingungs_zer;
var schwingungs_zus;
var Cf64quad_f64iff;
var Cf64Mittlere_abw;
var Cf64Mittlerer_Betrag;
var mache_arbeiter;
var copy_vek;

function parameter_auslesen(){
	//var aufl = document.getElementById("aufl");
	//zeit = Number(zeit_anzeige.value);
	//zeitraum = Number(zeitraum_anzeige.value);
	//ordnung = Number(ordnung_anzeige.value);
	//zeitschritte = Number(zeitschritte_anzeige.value);
	keinrand = keinrand_anzeige.checked ? 1 : 0;
	gitterpunkte = Number(gitterpunkte_anzeige.value);
	masse = Number(masse_anzeige.value);
	breite = Number(breite_anzeige.value);
	
	/*gp_zp_ae = Number(gp_zp_ae_anzeige.value);
	gp_zp_ges = Number(gp_zp_ges_anzeige.value);
	
	gp_rp_ae = Number(gp_rp_ae_anzeige.value);
	gp_rp_ges = Number(gp_rp_ges_anzeige.value);
	
	gp_m_ae = Number(gp_m_ae_anzeige.value);
	gp_m_ges = Number(gp_m_ges_anzeige.value);
	
	gp_o_ae = Number(gp_o_ae_anzeige.value);
	gp_o_ges = Number(gp_o_ges_anzeige.value);
	
	gp_wh = Number(gp_wh_anzeige.value);*/
	
	//parameter_umsetzen();
	//parameter_anzeigen();
}
window.parameter_auslesen = parameter_auslesen
function parameter_umsetzen(){
	
}
function parameter_anzeigen(){
	//var aufl = document.getElementById("aufl");
	//zeit_anzeige.value = zeit;
	//zeitraum_anzeige.value = zeitraum;
	//ordnung_anzeige.value = ordnung;
	//zeitschritte_anzeige.value = zeitschritte;
	gitterpunkte_anzeige.value = gitterpunkte;
	masse_anzeige.value = masse;
	breite_anzeige.value = breite;
	
	/*gp_zp_ae_anzeige.value = gp_zp_ae;
	gp_zp_ges_anzeige.value = gp_zp_ges;
	
	gp_rp_ae_anzeige.value = gp_rp_ae;
	gp_rp_ges_anzeige.value = gp_rp_ges;
	
	gp_m_ae_anzeige.value = gp_m_ae;
	gp_m_ges_anzeige.value = gp_m_ges;
	
	gp_o_ae_anzeige.value = gp_o_ae;
	gp_o_ges_anzeige.value = gp_o_ges;
	
	gp_wh_anzeige.value = gp_wh;*/
}
var formelsammlung = {
	formelwählen:"//In diesem feld kann eine Formel für das Potential oder die Wellenfunktion über den Javascript-Syntax definiert werden.\n\n//Gesetzt werden kann:\n//r : Der Realteil der Wellenfunktion\n//i : Der Imaginärteil der Wellenfunktion\n//v : Das Potential\n\n//Die verfügbaren Variablen sind:\n//x : Ort\n//t : Zeit\n//alt_r : Alter Realteil der Wellenfunktion\n//alt_i : Alter Imaginärteil der Wellenfunktion\n//alt_v : Das alte Potential",
	test:"r = 0.0000001 * x * (L - x) * Math.sin(x * 0.4);\ni = 0.0000001 * x * (L - x) * Math.cos(x * 0.4);",
	kastenmoden:"var n = 1;\n\nr = Math.sin(x * n * Math.PI / L) * Math.sqrt(2 / L);\ni = 0;",
	gauss:"var a = 100;\nvar pos = L/2;\nvar k = 0.5;\n\nx -= pos;\nvar mul = Math.pow(2/(Math.PI*a*a),1/4)*Math.exp(-x * x/a/a);\nr = mul*Math.cos(k * x);\ni = mul*Math.sin(k * x);",
	kasten:"var breite = 100;\nvar tiefe = 0.05;\n\nv = 0;\nif(Math.abs(x - L/2) < breite){\n    v = -tiefe;\n}",
	harmonisch:"var a = 0.000001;\n\nv = a*Math.pow(x-L/2, 2);",
	defokus:"var a = 10;\n\nv = a * (r * r + i * i);",
	impulsversch:"var k = 0.1;\n\ni = alt_i*Math.cos(k*x) + alt_r*Math.sin(k*x);\nr = alt_r*Math.cos(k*x) - alt_i*Math.sin(k*x);",
	einsdurchx:"var a = -0.1;\n\nv = a/(Math.abs(x-L/2));",
	interferenzexp:"var b = 0.092;\nvar a = 100;\nvar pos = L/4;\nvar k = 0.5;\n\nv = b/(Math.abs(x-L/2));\nx -= pos;\nvar mul = Math.pow(2/(Math.PI*a*a),1/4)*Math.exp(-x * x/a/a);\nr = mul*Math.cos(k * x);\ni = mul*Math.sin(k * x);",
	halberoszillator: "var a = 0.0000001;\n\nv = a*((x-L)*(x-L) - L*L);",
	gitter:"var n = 4;//spaltzahl\nvar d = 20;//spaltabstand\nvar b = 4;//spaltbreite\nvar m = L/2;//mitte\n\nr = 0;\ni = 0;\nfor(let i = 0; i < n; i++){\n	y = x - m + ((n - 1)*d/2)-i*d;\n	r += Math.pow(2/(Math.PI*b*b),1/4)*Math.exp(-y*y/b/b)*Math.sqrt(1/n);\n}",
	oszillatormoden:"var a = 0.000001;\nvar mitte = L/2;\nvar bes = [[0,0], [0,0], [0,0], [1,0]];\n\nvar w = Math.sqrt(a*2/m);\nvar l = Math.sqrt(1/(m*w));\nvar u = (x-mitte)/l;\n\nr=0;\ni=0;\nv = a*Math.pow(x-mitte, 2);\nvar psi0 = Math.pow(1/Math.PI/l/l, 1/4)*Math.exp(-u*u/2);\n\nvar he1 = [1];\nvar he2 = [0, 2];\n\nvar temp;\nvar ar = 1;\nfor(let j = 0; j < bes.length; j++){\n\tfor(let k = 0; k < he1.length; k++){\n\t\ttemp = Math.pow(u, k)*he1[k]/Math.sqrt(Math.pow(2, j)*ar);\n\t\tr += temp*bes[j][0];\n\t\ti += temp*bes[j][1];\n\t}\n\tar *= j + 1;\n\ttemp = he2;\n\the2 = [0].concat(he2);\n\tfor(let k = 0; k < he1.length; k++){\n\t\the2[k] = he2[k]*2 - (j + 1)*2*he1[k];\n\t}\n\tfor(let k = he1.length; k <he2.length;k++)\n\t\the2[k] = he2[k]*2;\n\the1 = temp;\n\tif(x == 0){console.log(j + 2 + \": \" + he2);}\n}\n\nr *= psi0;\ni *= psi0;"
}
function formelAendern(){
	formelfeld.value = formelsammlung[formelwahl.value];
}
window.formelAendern = formelAendern
function neustart(){
	parameter_auslesen();
	framezahl = 0;
	//zeit_anzeige.value = 0; 
	//zeitschritt = zeitraum / zeitschritte;
	
	//zerleg.setze_masse(masse);
	if(wandelpot)
		wandelpot.fertig();
	wandelpot = new s1d.wandelpot(uhr.valueAsNumber, gitterpunkte_anzeige.value, anfwert, anfwert + breite_anzeige.value, wandelpot_aufl, 0);

	if(berechnen)
		berechnen.fertig();
	berechnen = new f64_SCHROED_BERECHNEN(gitterpunkte_anzeige.value, anfwert, anfwert + breite_anzeige.value, masse_anzeige.value, wandelpot, keinrand);
	pseudozufallsvektor();
	
	
	
	berechnen.vek.fuelle(zerleg.ptr, uhr.valueAsNumber);
	berechnen.vek.randbedingung(keinrand);

	zeichnen();
}
window.neustart = neustart
function parameterUmschalten(){
	if(parameterblockda)
		parameterblock.style.display = "none";
	else
		parameterblock.style.display = "block";
	parameterblockda = !parameterblockda;
}
function anzeigeAendern(){
	xinfo.style.display = Rcheck.checked || D3check.checked || Icheck.checked || Qcheck.checked || Pcheck.checked ? "block":"none";
	norminfo.style.display = Rcheck.checked || Icheck.checked || D3check.checked || Qcheck.checked ? "block":"none";
	vekyinfo.style.display = Rcheck.checked || D3check.checked || Icheck.checked ? "block":"none";
	quadyinfo.style.display = Qcheck.checked ? "block":"none";
	potyinfo.style.display = Pcheck.checked ? "block":"none";
	zeichnen();
}
window.anzeigeAendern = anzeigeAendern
function normierevek(){
	berechnen.vek.normiere();
	zeichnen();
}
window.normierevek = normierevek

function potmodusumschalten(){
	wandelpot.modus = potmodus.checked?1:0;
}
window.potmodusumschalten = potmodusumschalten


document.oncontextmenu = (e)=>{e.preventDefault()};
document.onmousemove = bewegeMaus;
function bewegeMaus(e){
	var x = getcanvasx(e);
	var y = getcanvasy(e);
	xlabel.textContent = koord.getinnenx(x).toPrecision(2);
	vekylabel.textContent = koord.getinneny(y).toPrecision(2);
	quadylabel.textContent = koordQ.getinneny(y).toPrecision(2);
	potylabel.textContent = koordPot.getinneny(y).toPrecision(2);
	if(malen){
		stift.malen(x, y, xalt, yalt);
	}
	
	xalt = x;
	yalt = y;
}

canvas.ontouchstart = (e)=>MausRunter(e.touches[0])
canvas.ontouchmove = (e)=>bewegeMaus(e.touches[0])
canvas.ontouchend = (e)=>MausHoch(e.touches[0])
canvas.ontouchcancle = (e)=>MausHoch(e.touches[0])

canvas.onmousedown = MausRunter;
function MausRunter(e) {
	xalt = getcanvasx(e);
	yalt = getcanvasy(e);
	malen = true;
	stift = e.button == 0 ? lstift : rstift;
	stift.start(xalt, yalt);
	e.preventDefault()
};

canvas.onmouseup = MausHoch;
function MausHoch(e) {
	if(malen){
		var x = getcanvasx(e);
		var y = getcanvasy(e);
		malen=false;
		stift.malen(x, y, xalt, yalt);
		stift.stop(x, y, xalt, yalt);
	}
};
canvas.onmouseenter = function(e) {
	xalt = getcanvasx(e);
	yalt = getcanvasy(e);
	
};
canvas.onmouseleave = function(e) {
	if(malen){
		malen=false;
		stift.stop(getcanvasx(e), getcanvasy(e), xalt, yalt);
	}
};
document.onkeyup = function(e){
	if(document.activeElement==formelfeld)
		return;
	if(e.key == " "){
		start_stop();
		e.preventDefault();
	}

	if(e.key == "i"){
		uhr.valueAsNumber = wandelpot.naechster_frame(uhr.valueAsNumber);
		zeichnen();
		e.preventDefault();
	}
	if(e.key == "k"){
		uhr.valueAsNumber = wandelpot.letzter_frame(uhr.valueAsNumber);
		zeichnen();
		e.preventDefault();
	}
	if(e.key == "p"){
		parameterUmschalten();
		e.preventDefault();
	} 
}
document.onkeydown = function(e){
	if(document.activeElement==formelfeld)
		return;
	if(e.key == " "){
		e.preventDefault();
	}
	if(e.key === "l"){
		zeitwandel(deltat.valueAsNumber,schritteproframe.value);
		zeichnen();
		e.preventDefault();
	}
	if(e.key === "j"){
		zeitwandel(-deltat.valueAsNumber,schritteproframe.value);
		zeichnen();
		e.preventDefault();
	}
	if(e.key === "a"){
		if(koord.kipp > -0.5)
			koord.kipp -= 0.01;
		zeichnen();
		e.preventDefault();
	}
	if(e.key === "d"){
		if(koord.kipp < 0.5)
			koord.kipp += 0.01;
		zeichnen();
		e.preventDefault();
	}
	if(e.key === "w"){
		rotiereVektor(rotationsgeschwindigkeit);
		e.preventDefault();
	}
	if(e.key === "s"){
		rotiereVektor(-rotationsgeschwindigkeit);
		e.preventDefault();
	}
	if(e.key === "x"){
		if(wandelpot.aktueller_frame(uhr.valueAsNumber) == uhr.valueAsNumber)
			wandelpot.loescheframe(uhr.valueAsNumber);
		zeichnen();
		e.preventDefault();
	}
	if(e.key === "q"){
		glaetten_funktion()
		e.preventDefault();
	}
	if(e.key === "n"){
		normierevek();
		e.preventDefault();
	}
	if(e.key == "p"){
		e.preventDefault();
	}
}

function rotiereVektor(winkel){
	berechnen.vek.rotiere(winkel);
	rotationswinkel += winkel;
	zeichnen();

}
function vektoraktualisieren(){
	parameter_auslesen()
	var neuber = berechnen.klone(gitterpunkte_anzeige.value, 0, breite_anzeige.value, masse_anzeige.value, keinrand);
	berechnen.fertig();
	berechnen = neuber;
	ansichtEinrichten();
	zeichnen();
}
window.vektoraktualisieren = vektoraktualisieren
function getcanvasx(e){
	return e.clientX-canvas.getBoundingClientRect().left;
}
function getcanvasy(e){
	return e.clientY-canvas.getBoundingClientRect().top;
}


function start_stop(){
	if(!aktiv)
		window.requestAnimationFrame(hauptschleife);
	aktiv = !aktiv;
	startstop_button.textContent = aktiv ? "Pause" : "Start";
}
window.start_stop = start_stop
function formelanwenden(){
	vekZuweisen(formelfeld.value);
	potZuweisen(formelfeld.value);
	zeichnen();
}
window.formelanwenden = formelanwenden
function vekZuweisen(str){
	var getC = Function("return function(x, t, L, m, alt_r, alt_i, alt_v){var v = alt_v; var r = alt_r; var i = alt_i; "+str+"; return {im: i, re: r};};")();
	var arr = berechnen.vek.getarr();
	var x = berechnen.xanf;
	var st = berechnen.deltax;
	var len2 = berechnen.len*2;
	var breite = berechnen.breite;
	for(let i = 0; i < len2; i+= 2){
		var r = getC(x, uhr.valueAsNumber, breite, masse_anzeige.value, arr[i], arr[i+1], wandelpot.auswerten(x, uhr.valueAsNumber));
		arr[i] = r.re;
		arr[i+1] = r.im;
		x += st;
	}
}
function potZuweisen(str){
	var getV = Function("return function(x, t, L, m, alt_r, alt_i, alt_v){ var r = alt_r; var i = alt_i; var v = alt_v; "+str+"; return v;};")();
	wandelpot.strich(0,0,0,0,uhr.valueAsNumber);
	var inf = wandelpot.getframeinfo(uhr.valueAsNumber);
	var arr = inf.arr;
	var x = inf.xanf;
	var st = inf.deltax;
	var len = inf.len;
	var breite = berechnen.breite;
	for(let i = 0; i < len; i++){
		arr[i] = getV(x, uhr.valueAsNumber, breite, masse_anzeige.value, berechnen.vek.R_auswerten(x), berechnen.vek.I_auswerten(x), arr[i]);
		x += st;
	}
}

function glaetten_funktion(){
	glaetten(glaettordnung.valueAsNumber);
	zeichnen();
}
window.glaetten_funktion = glaetten_funktion

function ansichtEinrichten(){
	canvas.width = fenster.getBoundingClientRect().width//window.innerWidth;
	canvas.height = fenster.getBoundingClientRect().height;//window.innerHeight;
	var grenze = 1 / vekgroesse.value;
	var xanf = berechnen?berechnen.xanf:xinnenanf;
	var xend = berechnen?berechnen.xend:xinnenend;
	koord = new f64_KOORD(canvas.width, canvas.height, xanf, xend, grenze, -grenze,  koord?koord.kipp:0);
	grenze = 1 / potgroesse.value;
	koordPot = new f64_KOORD(canvas.width, canvas.height, xanf, xend, grenze, -grenze, 0);
	grenze = 1 / quadvekgroesse.value;
	koordQ = new f64_KOORD(canvas.width, canvas.height, xanf, xend, grenze, 0, 0);
}
function ansichtsAenderung(){
	ansichtEinrichten();
	zeichnen();
}
window.ansichtsAenderung = ansichtsAenderung


function zeichnen(){
	ctx.clearRect(0,0,canvas.width, canvas.height);
	ctx.lineJoin = "bevel";
	//koord.zeichnen(ctx, berechnen.vek.wertbeiR, uhr.valueAsNumber, "rgb(0,255,0)");
	//koord.zeichnen(ctx, berechnen.vek.wertbeiI, uhr.valueAsNumber, "rgb(255,0,0)");
	if(Qcheck.checked)
		koordQ.fuellen(ctx, berechnen.vek.wertbeiQ, uhr.valueAsNumber, Qfarbe.value, strichstaerke.value, true);
	
	if(D3check.checked)
		koord.komplexZeichnen(ctx, berechnen.vek.wertbeiR, berechnen.vek.wertbeiI, uhr.valueAsNumber, D3farbe.value, strichstaerke.value);
	
	if(Rcheck.checked)
		koord.zeichnen(ctx, berechnen.vek.wertbeiR, uhr.valueAsNumber, Rfarbe.value, strichstaerke.value);
	if(Icheck.checked)
		koord.zeichnen(ctx, berechnen.vek.wertbeiI, uhr.valueAsNumber, Ifarbe.value, strichstaerke.value);
	if(Pcheck.checked)
		koordPot.zeichnen(ctx, wandelpot.wertbeiptr, uhr.valueAsNumber, Pfarbe.value, strichstaerke.value);
		
	betragBerechnen();
	zeitlabel.textContent = uhr.valueAsNumber.toFixed(0);
}
window.zeichnen = zeichnen

function SchwingungsZerlegung(){
	Modul.ccall('SchwingungsZerlegung', 'null', ['number','number','number','number','number'], [getvek_buff(), laenge, schwingungsAnteile_buff, Dreh(), ordnung]);
}

function Dreh(){
	return uhr.valueAsNumber*Math.PI*Math.PI/(2*masse*laenge*laenge);
}

function setzeSin(vek, len, n, norm){
	var mul = n*Math.PI/(len-1);
	for(let i = 0;i<len;i+=1){
		vek[i*2] = Math.sin(i*mul) * norm;
		vek[i*2+1] = 0;
	}
}
function PotNull(){
	var pot = getpot();
	for( let i = 0; i < laenge; i++)
		pot[i] = 0;
}

class ZEIT_KONZEPT{schreibe(schr){schr.schreibeF64(uhr.valueAsNumber);}}
Konzepte.push(ZEIT_KONZEPT);
ZEIT_KONZEPT.segmentLesen = (les)=>{
	uhr.valueAsNumber = les.leseF64();
}
ZEIT_KONZEPT.titel = "F64ZEIT";


class f64_SCHROED_BERECHNEN{
	constructor(len, xanf, xend, mass, pot, periodisch){
		this.len = len;
		this.xanf = xanf;
		this.xend = xend;
		this.breite = xend - xanf;
		this.deltax = this.breite/(len - 1);
		this.mass = mass;
		this.dvek = new s1d.CDoppelVek(len,  xanf, xend, null);
		this.pot = pot; // <- Flexibel Pot
		//this.pot = new f64_DOPPEL_VEK(len,  xanf, xend, uhr.valueAsNumber, null); //<- Standard Pot
		this.rkm = new s1d.rungekuttamatrix(4, [0,0.5, 0.5,0,0.5,0.5,0,0,1,1,1.0/6,1.0/3,1.0/3,1.0/6]);
		this.eul = new s1d.schroed(this.pot.wertbeiptr, len, xanf, xend, mass, periodisch);
		this.add = new s1d.plus(len * 2);
		this.run = new s1d.rungekutta(len * l_f64 * 2, this.rkm, this.eul, this.add);
		this.fertig = ()=>{
			this.dvek.fertig();
			//this.pot.fertig(); //<- Standard Pot
			this.rkm.fertig();
			this.eul.fertig();
			this.add.fertig();
			this.run.fertig();
		};
		this.iteration = (zeit, zeitschritt)=>{
			this.dvek.tausche();
			this.run.iteration(this.dvek.alt.ptr, this.dvek.neu.ptr, zeit, zeitschritt);
		};
	}
	klone(len, xanf, xend, mass, periodisch){
		var temp = new s1d.CVek(this.len, xanf, xend, null);
		var r = new f64_SCHROED_BERECHNEN(len, xanf, xend, mass, this.pot, periodisch);
		temp.getarr().set(this.vek.getarr());
		r.vek.fuelle(temp.wertbei);
		r.vek.randbedingung(periodisch);
		temp.fertig();
		return r;
	}
	schreibe(schr){
			schr.schreibeUInt(this.len);
			schr.schreibeF64(this.xanf);
			schr.schreibeF64(this.xend);
			schr.schreibeF64(this.mass);
			schr.schreibeF64Daten(getByteArrVonPtr(this.vek.ptr, this.len * 2 * l_f64));
	}
	setze_pot(pot){
		this.pot = pot;
		this.eul.setze_pot_ptr(pot.wertbeiptr);
	}
	
	get vek(){return this.dvek.neu;}
	get vek_ptr(){return this.dvek.neu.ptr;}
	get vek_arr(){return this.dvek.neu.getarr();}
}
Konzepte.push(f64_SCHROED_BERECHNEN);
f64_SCHROED_BERECHNEN.titel = "F64_SCHROED";
f64_SCHROED_BERECHNEN.lese = (les)=>{
	var len = les.leseUInt();
	var anf = les.leseF64();
	var end = les.leseF64();
	var masse = les.leseF64();
	var ber = new f64_SCHROED_BERECHNEN(len, anf, end, masse, wandelpot);
	ber.vek.getarr().set(les.leseF64Daten(len * 2));
	return ber;
}
f64_SCHROED_BERECHNEN.segmentLesen = (les)=>{
	var neu = f64_SCHROED_BERECHNEN.lese(les);
	if(berechnen)
		berechnen.fertig();
	berechnen = neu;
	gitterpunkte_anzeige.value = berechnen.len;
	breite_anzeige.value = berechnen.breite;
	masse_anzeige.value = berechnen.mass;
}



function getf64ArrVonPtr(ptr, len){
	var p = ptr >> l_f64_potenz;
	return Modul.HEAPF64.subarray(p, p + len);
}
function getByteArrVonPtr(ptr, len){
	return Modul.HEAPU8.subarray(ptr, ptr + len);
}
function getCf64WertBei(ptr, raum, zeit){
	
}


class f64_KOORD{
	constructor(breite, hoehe, xanf,xend, yanf, yend, kipp){
		this.breite = breite;
		this.hoehe = hoehe;
		this.xanf = xanf;
		this.xend = xend;
		this.yanf = yanf;
		this.yend = yend;
		this.kipp = kipp;
		this.innenbreite = xend- xanf;
		this.innenhoehe = yend - yanf;
		this.xstretch = this.innenbreite/(breite - 1);
		this.ystretch = this.innenhoehe / (hoehe - 1);
		this.xstretchinv = 1 / this.xstretch;
		this.ystretchinv = 1 / this.ystretch;
		this.xnull = -xanf * this.xstretchinv;
		this.ynull = -yanf * this.ystretchinv;
		this.fuellen = (ctx, vek, zeit, farbe, strichkraft)=>
		{
			ctx.beginPath();
			ctx.lineWidth = strichkraft;
			ctx.fillStyle = farbe;
			ctx.moveTo(0, this.hoehe)
			let f = this.xanf;
			for(let i=0;i<breite;i+=1)
			{
				let wb = f64_wertbei(vek, f, zeit);
				ctx.lineTo(i, this.ynull + wb*this.ystretchinv);
				f += this.xstretch;
			}
			ctx.lineTo(this.breite, this.hoehe)
			ctx.fill();
		};
		this.zeichnen = (ctx, vek, zeit, farbe, strichkraft, fuellung)=>
		{
			ctx.beginPath();
			ctx.lineWidth = strichkraft;
			ctx.strokeStyle = farbe;
			let f = this.xanf;
			for(let i=0;i<breite;i+=1)
			{
				let wb = f64_wertbei(vek, f, zeit);
				ctx.lineTo(i, this.ynull + wb*this.ystretchinv);
				f += this.xstretch;
			}
			ctx.stroke();	
		};
		this.komplexZeichnen = (ctx, vekr, veki, zeit, farbe, strichkraft)=>
		{
			ctx.beginPath();
			ctx.lineWidth = strichkraft;
			ctx.strokeStyle = farbe;
			let f = this.xanf;
			for(let i=0;i<breite;i+=1)
			{
				let wbr = f64_wertbei(vekr, f, zeit);
				let wbi = f64_wertbei(veki, f, zeit);
				ctx.lineTo(i + wbi*this.ystretchinv*this.kipp, this.ynull + wbr*this.ystretchinv);
				f += this.xstretch;
			}
			ctx.stroke();	
		};
		this.getinnenx = (aussenx)=>{return this.xanf + aussenx * this.xstretch;};
		this.getinneny = (ausseny)=>{return this.yanf + ausseny * this.ystretch;};
		this.getaussenx = (innenx)=>{return (innenx - this.xanf)/this.xstretch;};
		this.getausseny = (inneny)=>{return (inneny - this.yanf)/this.ystretch;};
	}
}



function glaetten(ordnung){
	var ptr = Modul._malloc(ordnung*2*l_f64);
	cf64_SchwingungsZerlegung(berechnen.vek_ptr, berechnen.len, ptr, ordnung);
	cf64_SchwingungsZusammensetzung(ptr, ordnung, berechnen.vek_ptr, berechnen.len);
	Modul._free(ptr);
	berechnen.vek.normiere();
}


function bereit(){

	getf64 = s1d.getf64
	setf64 = s1d.setf64
	re_f64_wertbei = s1d.re_f64_wertbei
	im_f64_wertbei = s1d.im_f64_wertbei
	f64_wertbei = s1d.f64_wertbei
	Dsetzekonst = s1d.Dsetzekonst
	cf64_SchwingungsZerlegung = s1d.cf64_SchwingungsZerlegung
	cf64_SchwingungsZusammensetzung = s1d.cf64_SchwingungsZusammensetzung
	schwingungs_zer = s1d.schwingungs_zer
	schwingungs_zus = s1d.schwingungs_zus
	Cf64quad_f64iff = s1d.Cf64quad_f64iff
	Cf64Mittlere_abw = s1d.Cf64Mittlere_abw
	Cf64Mittlerer_Betrag = s1d.Cf64Mittlerer_Betrag
	mache_arbeiter = s1d.mache_arbeiter;
	copy_vek = s1d.copy_vek

	console.log("Bereit");
	
	lstift = new potential_stift()
	rstift = new vektor_stift(100)
	
	uhr.valueAsNumber = 0;
	ansichtEinrichten();
	window.onresize = ansichtsAenderung;
	parameter_anzeigen();
	//pseudozufallsvektor();
	neustart();
	anzeigeAendern();
	//zeichnen();
}
function zerlegneu(){
	if(zerleg != undefined){
		zerleg.fertig();
	}
	zerleg = new s1d.moden(ordnung,  anfwert, anfwert + breite_anzeige.value, masse_anzeige.value);
}
function zufallsvektor(){
	zerlegneu();
	let arr = zerleg.arr;
	for(let i = ordnung * 2 - 1; i > 0; i--)
		arr[i] = (Math.random()-0.5)*2;
	arr[ordnung*2] = 1;
	zerleg.normiere();
}
function pseudozufallsvektor(){
	zerlegneu();
	let arr = zerleg.arr;
	var i = 0;
	for(i = 0; i < arr.length; i ++){
	arr[i] = (((99991*i*i)%1033)/(1031 + 1)-0.5)*2;//1031 + 1 verhindert 3 2 -> 6 4 bit konvertierung durch suchen + ersetzen
	}
	arr[0] = 0;
	arr[1] = 0;
	arr[zerleg.arr.length-2] = 1;
	arr[zerleg.arr.length-1] = 0;
	zerleg.normiere();
}
function setze_o(wert){
	ordnung = wert;
	pseudozufallsvektor();
}

function zeitwandel(schritt, anzahl){
	for(let i =0;i<anzahl; i++){
		berechnen.iteration(uhr.valueAsNumber, schritt);
		uhr.valueAsNumber += schritt;
	}
	
	//betrquad_anzeige.textContent = ""+betrquad;
}

function betragBerechnen(){
	betrquad = s1d.CVek.Cf64betrquad(berechnen.vek_ptr, berechnen.vek.len, berechnen.vek.breite);//TODO: berechnen.vek.neu.betrquad;
	var betrabw = (Math.sqrt(betrquad) - 1);
	normlabel.textContent =  betrabw < 0 ?
		"1 - " + (-betrabw).toPrecision(2) : "1 + " + betrabw.toPrecision(2);
}

function hauptschleife(){
	if(aktiv){
		zeitwandel(deltat.valueAsNumber,schritteproframe.value);
		window.requestAnimationFrame(hauptschleife);
		zeichnen();
	}
}


function automatisch_start(){

	start_z = uhr.valueAsNumber;
	start_gp = gitterpunkte;
	start_zp = zeitschritte;
	start_m = masse;
	start_o = ordnung;
	
	gp_zp_zaehler = 1;
	gp_rp_zaehler = 1;
	gp_o_zaehler = 1;
	gp_m_zaehler = 1;
	gp_wh_zaehler = 1;
	
	datn = "m"+masse+"o"+ordnung+"zi"+zeitraum+"ri"+breite+"zp"+zeitschritte+"rp"+gitterpunkte+"mae"+gp_m_ae+"mg"+gp_m_ges+"oae"+gp_o_ae+"og"+gp_o_ges+"zpae"+gp_zp_ae+"zpg"+gp_zp_ges+"rpae"+gp_rp_ae+"rpg"+gp_rp_ges+"w"+gp_wh+"f64";
	outp = ""
	outp += "# masse: " + masse + nl;
	outp += "# raumintervall: " + breite + nl;
	outp += "# zeitintervall: " + zeitraum + nl;
	outp += "# zeitpunkte: " + zeitschritte + nl;
	outp += "# raumpunkte: " + gitterpunkte + nl;
	outp += "# ordnung: " + ordnung + nl;
	outp += "# Präzision: f64" + nl;
	outp += "# Wiederholungen: " + gp_wh + nl;
	outp += "# Zeitpunkte Änderung: " + gp_zp_ae + " Gesamtmessungen: " + gp_zp_ges + nl;
	outp += "# Raumpunkte Änderung: " + gp_rp_ae + " Gesamtmessungen: " + gp_rp_ges + nl;
	outp += "# Ordnung Änderung: " + gp_o_ae + " Gesamtmessungen: " + gp_o_ges + nl;
	outp += "# Masse Änderung: " + gp_m_ae + " Gesamtmessungen: " + gp_wh + nl;
	outp += "# Plotte:"+ nl + "#Masse Ordnung Zeitpunkte Raumpunkte Zeit mittel_abw_betr_num_anal  mittel_betr_anal norm_betr_num"+ nl + nl;
	
	pseudozufallsvektor();
	neustart();
}
function automatisch(){
	outp += masse + " " + ordnung + " " + zeitschritte + " " + gitterpunkte + " " + uhr.valueAsNumber + " " + mdiff+" "+ betrdurch + " " + betrquad + " " + nl;
	outpanzeige.value = outp;
	
	if(gp_wh_zaehler < gp_wh){
			gp_wh_zaehler += 1;
			framezahl = 0;
			if(!aktiv)
				window.requestAnimationFrame(hauptschleife);
			aktiv = true;
		}
	else{
		if(gp_wh != 1)
			outp += nl;
		uhr.valueAsNumber = start_z;
		gp_wh_zaehler = 1;
		if(gp_m_zaehler < gp_m_ges){
			gp_m_zaehler += 1;
			masse += gp_m_ae;
			neustart();
		}
		else{
			if(gp_m_ges != 1)
				outp += nl;
			if(gp_o_zaehler < gp_o_ges){
				setze_o(ordnung + gp_o_ae);
				neustart();
				gp_o_zaehler += 1;
			}
			else{
				if(gp_o_ges != 1)
					outp += nl;
				setze_o(start_o);
				gp_o_zaehler = 1;
				
		
				masse = start_m;
				gp_m_zaehler = 1;
				if(gp_zp_zaehler < gp_zp_ges){

					zeitschritte += gp_zp_ae;
					neustart();
		
					gp_zp_zaehler += 1;
				}
				else if(gp_rp_zaehler < gp_rp_ges){
					if(gp_zp_ges != 1)
						outp += nl;
					gp_zp_zaehler = 1;
					zeitschritte = start_zp;
		
					gitterpunkte += gp_rp_ae;
					neustart();
		
					gp_rp_zaehler += 1;
				}
				else{
						a.href = URL.createObjectURL(new Blob([outp]));
						a.download = datn + ".txt";
						a.click();
		
						uhr.valueAsNumber = start_z;
						gitterpunkte = start_gp;
						zeitschritte = start_zp;
						masse = start_m;
						setze_o(start_o);
					}
			}
		}
	}
	parameter_anzeigen();
}




function buffer_aus_Datei(f){
	return new Promise((resolve, reject) => {
			var reader = new FileReader();
			reader.onload = () => { resolve(reader.result ); };
			reader.readAsArrayBuffer(f);
		});
}

function leseAlleSegmente(les){
	while(les.pos != null && les.pos < les.buff.byteLength){
		var aktuell = les.leseSegment();
		for(let i = 0; i< Konzepte.length;i++)
			if(Konzepte[i].titel == aktuell.titel)
				Konzepte[i].segmentLesen(aktuell);
		
	}
}

function testeStopp(){
	if( zeitraum < uhr.valueAsNumber + deltat.valueAsNumber / 2){
		start_stop();
		return true;
	}
	return false;
}

class schreibevorgang{
	constructor(arr = []){
		this.arr = arr;
	}
	schreibeF64(nummer){
		var v = new Float64Array(1);
		v[0] = nummer;
		this.arr.push(v);
	}
	schreibeUInt8(nummer){
		var zahl = new Uint8Array(1);
		zahl[0] = nummer;
		this.arr.push(zahl);
	}
	schreibeUInt(nummer){
		var zahl = new Uint32Array(1);
		zahl[0] = nummer;
		this.arr.push(zahl);
	}
	schreibeSegment(name, schr){
		name += ":";
		var encoder = new TextEncoder()
		var textenc = encoder.encode(name);
		this.arr.push(textenc);
		var blo = new Blob(schr.arr);
		this.schreibeUInt(blo.size);
		this.arr.push(blo);	
	}
	schreibeF64Daten(arr){
		this.arr.push(arr);
		console.log(this.arr);
	}
	Blob(){
		return new Blob(this.arr);
	}
}
class lesevorgang{
	constructor(buff, pos = 0){
		this.pos = pos;
		this.buff = buff;
	}
	leseUInt(){
		if(this.buff.byteLength - this.pos < 4)
			return null;
		var wert = new Uint32Array(this.buff.slice(this.pos, this.pos + 4))[0];
		this.pos += 4;
		return wert;
	}
	leseUInt8(){
		if(this.buff.byteLength - this.pos < 1)
			return null;
		var wert = new Uint8Array(this.buff.slice(this.pos, this.pos + 1))[0];
		this.pos += 1;
		return wert;
	}
	leseSegment(){
		var na = this.findeDoppelpunkt();
		var len = this.leseUInt();
		var r = new lesevorgang(this.buff.slice(this.pos, this.pos + len));
		this.pos += len;
		r.titel = na;
		return r;
	}
	leseF64(){
		if(this.buff.byteLength - this.pos < l_f64)
			return null;
		var wert = new Float64Array(this.buff.slice(this.pos, this.pos + l_f64))[0];
		this.pos += l_f64;
		return wert;
	}
	leseF64Daten(laenge){
		var len = (laenge << l_f64_potenz);
		var wert = this.buff.slice(this.pos, this.pos + len);
		this.pos += len;
		return new Float64Array(wert);
	}
	
	findeDoppelpunkt(){
	var arr = new Uint8Array(this.buff);
	var i = this.pos;
	var wert;
	while(i < arr.byteLength){
		if(arr[i] == 58)
		{
			var dec = new TextDecoder();
			wert = dec.decode(arr.slice(this.pos, i));
			this.pos = i + 1;
			return wert;
		}
		i++;
	}
	return null;
}
}

function speichern(){
	schr = new schreibevorgang();
	
	var neu;
	
	if(speicherverhalten.value>0){
		neu = new schreibevorgang();
		wandelpot.schreibe(neu);
		schr.schreibeSegment(f64_WANDEL_POT.titel, neu);
	}
	
	if(speicherverhalten.value<2){
	neu = new schreibevorgang();
	berechnen.schreibe(neu);
	schr.schreibeSegment(f64_SCHROED_BERECHNEN.titel, neu);
	
	neu = new schreibevorgang();
	new ZEIT_KONZEPT().schreibe(neu);
	schr.schreibeSegment(ZEIT_KONZEPT.titel, neu);
	}
	
	
	
	/*var vek = berechnen.vek_arr;
	var pot = getpot();
	
	var a = document.getElementById("a");
	var arr = [];
	schr.schreibeSegment(arr, "f64_compl_1d_arr", [vek.buffer.slice(vek.byteOffset, vek.byteOffset + vek.byteLength)]);
	schreibeSegment(arr, "f64_1d_arr", [pot.buffer.slice(pot.byteOffset, pot.byteOffset + pot.byteLength)]);
	schreibeSegment(arr, "zeit_f64", [Schreibef64(zeit)]);
	schreibeSegment(arr, "gitter_punkt_abstand_f64", [Schreibef64(gitterPunktAbstand)]);
	schreibeSegment(arr, "zeit_schritt_f64", [Schreibef64(deltat.valueAsNumber)]);
	schreibeSegment(arr, "masse_f64", [Schreibef64(masse)]);*/
	speicherlink.href = URL.createObjectURL(schr.Blob());
	speicherlink.download = prompt("Bitte den Dateinamen eingeben");
	speicherlink.click();
}
window.speichern = speichern
function laden(e){
	var files = e.target.files; // FileList object

	// files is a FileList of File objects. List some properties.
	var output = [];
	for (var i = 0, f; f = files[i]; i++) {
		var arr = buffer_aus_Datei(f).then((arr) => {
			//leseAlleSegmente(new lesevorgang(arr, 0));
			var les = new lesevorgang(arr, 0);
			leseAlleSegmente(les);
			zeichnen();
		});
	}
}
function segmentLaden(name, buff){
	if(name == "f64_compl_1d_arr"){
		var vek = getvek();
		new Uint8Array(vek.buffer, vek.byteOffset, vek.byteLength).set(new Uint8Array(buff), 0);
	}else if(name == "f64_1d_arr"){
		var pot = getpot();
		new Uint8Array(pot.buffer, pot.byteOffset, pot.byteLength).set(new Uint8Array(buff), 0);
	}else if(name == "zeit_f64"){
		uhr.valueAsNumber = buff.leseF64();
	}else if(name == "gitter_punkt_abstand_f64"){
		gitterPunktAbstand = buff.leseF64();
	}else if(name == "zeit_schritt_f64"){
		deltat.valueAsNumber = buff.leseF64();
	}else if(name == "masse_f64"){
		masse = buff.leseF64();
	}
	parameter_anzeigen();
	parameter_aendern()
	console.log("das Segment heißt: " + name);
}


class potential_stift{
	rotiere(){}
	constructor(){
		
	}
	start(x, y){
	
	}
	malen(x, y, xalt, yalt){
		wandelpot.strich(koordPot.getinnenx(xalt), koordPot.getinnenx(x), koordPot.getinneny(yalt), koordPot.getinneny(y), uhr.valueAsNumber);
		zeichnen();
	}
	stop(x, y, xalt, yalt){
	
	}
}
class potential_stift_gerade{
	rotiere(){}
	constructor(){
		
	}
	start(x, y){
		this.xstart = x;
		this.ystart = y;
	}
	malen(x, y, xalt, yalt){
	}
	stop(x, y, xalt, yalt){
		wandelpot.strich(koordPot.getinnenx(this.xstart), koordPot.getinnenx(x), koordPot.getinneny(this.ystart), koordPot.getinneny(y));
		zeichnen();
	
	}
}
function aktiviere(){
	if(!this.aktiv){
		window.requestAnimationFrame(hauptschleife);
	}
}
class vektor_stift{
	rotiere(){}
	constructor(ordnung){
		this.ordnung = ordnung;
		this.aktiv = aktiv;
	}
	start(x, y){
		this.xstart = x;
		this.ystart = y;
		this.winkelalt = rotationswinkel;
	}
	malen(x, y, xalt, yalt){
		var dreh =  rotationswinkel - this.winkelalt;
		berechnen.vek.strich(koord.getinnenx(xalt), koord.getinnenx(x), koord.getinneny(yalt)*Math.cos(dreh), koord.getinneny(yalt)*Math.sin(dreh), koord.getinneny(y), 0);
		zeichnen();
		this.winkelalt = rotationswinkel;
	}
	stop(x, y, xalt, yalt){
		glaetten(glaettordnung.valueAsNumber);
		zeichnen();
		if(this.aktiv)
			aktiviere();
	}
}
function stiftAendern(){
	rstift = stiftFinden(rstiftselect.value)
	lstift = stiftFinden(lstiftselect.value)
}
window.stiftAendern = stiftAendern
function stiftFinden(n){
	if(n == "potstift")
		return new potential_stift();
	else if(n == "vekstift")
		return new vektor_stift(vekstiftordnung);
	else if(n == "potstift_g")
		return new potential_stift_gerade();
}




		</script>
	</body>
</html>
 
